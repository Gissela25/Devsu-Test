name: CI/CD â€” build, push to Artifact Registry & deploy to GKE

on:
  push:
    branches: [ main ]

env:
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin, kubectl

      - name: Authenticate (service account key)
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" > "${{ runner.temp }}/gcloud-key.json"
          gcloud auth activate-service-account --key-file="${{ runner.temp }}/gcloud-key.json"
          gcloud config set project "${{ secrets.GCP_PROJECT }}"

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-east1-docker.pkg.dev --quiet

      - name: Build image
        run: |
          IMAGE="us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.AR_REPOSITORY }}/${{ secrets.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          docker push "$IMAGE"

      - name: Get GKE credentials (try region then zones)
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          set -e
          echo "$GCP_SA_KEY" > "${{ runner.temp }}/gcloud-key.json"
          gcloud auth activate-service-account --key-file="${{ runner.temp }}/gcloud-key.json"
          gcloud config set project "$GCP_PROJECT"
          CLUSTER="$GKE_CLUSTER"
          REGION="$GCP_REGION"

          if gcloud container clusters get-credentials "$CLUSTER" --region "$REGION" --project "$GCP_PROJECT"; then
            echo "Got credentials using region $REGION"
          else
            for z in ${REGION}-a ${REGION}-b ${REGION}-c; do
              if gcloud container clusters get-credentials "$CLUSTER" --zone "$z" --project "$GCP_PROJECT"; then
                echo "Got credentials using zone $z"
                break
              fi
            done
          fi

      - name: Deploy (update image)
        run: |
          kubectl set image deployment/devsu-app devsu-container="$IMAGE" --record
          kubectl rollout status deployment/devsu-app --timeout=3m
