name: CI/CD — build → push to Artifact Registry → deploy to GKE

on:
  push:
    branches: [ main ]

env:
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    name: Build, publish and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Google Cloud SDK (install gcloud, kubectl)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin,kubectl
          export_default_credentials: false

      - name: Authenticate (service account key)
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          # write the SA json safely (preserve newlines & quotes)
          printf '%s' "$GCP_SA_KEY" > "${{ runner.temp }}/gcloud-key.json"
          # activate the service account
          gcloud auth activate-service-account --key-file="${{ runner.temp }}/gcloud-key.json"
          # set project
          gcloud config set project "$GCP_PROJECT"

      - name: Configure docker to push to Artifact Registry (us-east1)
        run: |
          gcloud auth configure-docker us-east1-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          IMAGE="us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.AR_REPOSITORY }}/${{ secrets.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Building $IMAGE"
          docker build -t "$IMAGE" .

      - name: Push image to Artifact Registry
        run: |
          docker push "$IMAGE"

      - name: Get GKE credentials (try region then zones)
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          set -e
          # ensure auth for this step too (runner temp is ephemeral)
          printf '%s' "$GCP_SA_KEY" > "${{ runner.temp }}/gcloud-key.json"
          gcloud auth activate-service-account --key-file="${{ runner.temp }}/gcloud-key.json"
          gcloud config set project "$GCP_PROJECT"

          CLUSTER="$GKE_CLUSTER"
          REGION="$GCP_REGION"

          echo "Trying regional get-credentials for cluster=$CLUSTER region=$REGION project=$GCP_PROJECT"
          if gcloud container clusters get-credentials "$CLUSTER" --region "$REGION" --project "$GCP_PROJECT"; then
            echo "Got credentials using region $REGION"
          else
            echo "Regional attempt failed — trying zones ${REGION}-a/b/c..."
            for z in ${REGION}-a ${REGION}-b ${REGION}-c; do
              if gcloud container clusters get-credentials "$CLUSTER" --zone "$z" --project "$GCP_PROJECT"; then
                echo "Got credentials using zone $z"
                break
              fi
            done
          fi

      - name: Deploy: update deployment image and rollout
        run: |
          # adjust deployment name and container name if your k8s manifest differs
          DEPLOYMENT_NAME="devsu-app"
          CONTAINER_NAME="devsu-container"

          # IMAGE comes from prior step via GITHUB_ENV
          echo "Using IMAGE=$IMAGE"
          if [ -z "$IMAGE" ]; then
            echo "ERROR: IMAGE variable is empty — build step may have failed."
            exit 1
          fi

          echo "Updating deployment/$DEPLOYMENT_NAME container $CONTAINER_NAME -> $IMAGE"
          kubectl set image deployment/${DEPLOYMENT_NAME} ${CONTAINER_NAME}="$IMAGE" --record
          kubectl rollout status deployment/${DEPLOYMENT_NAME} --timeout=3m
